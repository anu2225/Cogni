छान — मी तुझ्या PlanAndCoverage.tsx मध्ये Calculate Premium flow गाठवून final अपडेट केलेला component खाली देतो. हे बदल खाली करतात:

UI मध्ये Calculate Premium बटण आणि loading / error handling जोडले.

getPremium() функция — फॉर्ममधून (आणि काही डेटासाठी localStorage) request body बनवते आणि तुझ्या backend endpoint http://localhost:8001/api/calc/premium ला POST करते.

response आली की ते premiumResponse मध्ये दाखवते आणि शक्य असल्यास fields.basicPlanPremium update करते.

_1k_Extra_mortality सारखे value parsing (e.g. '75%' -> 0.75) आहे.

मूळ component मधील इतर कोड जसा तसा ठेवला — फक्त premium call + दर्शवणं add केलं.


> लक्षात घे: काही input (उदा. DOB, insured gender, occupation code) हा LifeAssured पेजवर आहेत — मी ते localStorage मधून वाचण्याचा fallback वापरला आहे (localStorage.getItem('insuredDob'), localStorage.getItem('insuredGender'), localStorage.getItem('occupation')). जर तू LifeAssured पेजवर हे नसेट करत नसशील तर request मध्ये ती फील्ड मोकळी जाईल — पण backend वरून error येऊ शकतो. (जर हवं तर मी त्या fields fields मध्ये add करून direct वापरू शकतो — पण तू LifeAssured आणि Plan पेज दोन वेगळे असल्यामुळे localStorage ही सोपी पद्धत आहे.)



खाली पूर्ण, paste-ready PlanAndCoverage.tsx — सरळ copy-paste कर:

// PlanAndCoverage.tsx (UPDATED - includes Calculate Premium API call)
import {
  Box,
  Divider,
  Link,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  TextField,
  Typography,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  SelectChangeEvent,
  Button,
  CircularProgress,
  Alert,
} from "@mui/material";

import React, { useEffect, useState } from "react";

import { useTranslation } from "react-i18next";

interface ChildComponentProps {
  fields: {
    basicPlan: string;
    basicSumInsured: string;
    basicPlanPremium: string;
    typeOfDivident: string;
    insuranceTerm: string;
    ppt: string;
    Product: string;
    Policy_Inception_Date: string;
    Smoker: string;
    Pre_Existing_Disease: string;
    Extra_mortality: string;
    Policy_Term: string;
    Mandatory_Premium_Period: string;
    PAV: string;
    per_mille_rating_death: string;
    per_mille_rating_TPD: string;
    per_mille_rating_SCI: string;
    Death_Benefit: string;
    Total_and_Permanent_Disability_TPD: string;
    Accidental_Death_and_Dismemberment_ADD: string;
    Staged_Critical_Illness_SCI: string;
    _2e_Hospital_Cash_Benefit_HCB: string;
    Partial_Withdrawl: string;
    Partial_Withdrawl_Amount: string;
  };

  setFields: React.Dispatch<
    React.SetStateAction<{
      basicPlan: string;
      basicSumInsured: string;
      basicPlanPremium: string;
      typeOfDivident: string;
      insuranceTerm: string;
      ppt: string;
      Product: string;
      Policy_Inception_Date: string;
      Smoker: string;
      Pre_Existing_Disease: string;
      Extra_mortality: string;
      Policy_Term: string;
      Mandatory_Premium_Period: string;
      PAV: string;
      per_mille_rating_death: string;
      per_mille_rating_TPD: string;
      per_mille_rating_SCI: string;
      Death_Benefit: string;
      Total_and_Permanent_Disability_TPD: string;
      Accidental_Death_and_Dismemberment_ADD: string;
      Staged_Critical_Illness_SCI: string;
      _2e_Hospital_Cash_Benefit_HCB: string;
      Partial_Withdrawl: string;
      Partial_Withdrawl_Amount: string;
    }>
  >;

  savedQuotation: any;

  savedTransaction: any;
}

const MAIN_PLANS = [
  "Term Insurance",
  "Whole Life Insurance",
  "Universal Life Insurance",
  "Endowment Plan",
];

const RIDERS = ["ADD", "CI", "WOP", "HCB", "DB"];

const YES_NO = ["Yes", "No"];

const PRODUCT_OPTIONS = ["a", "b"];

const EXTRA_MORTALITY_OPTIONS = [
  "5%",
  "10%",
  "15%",
  "20%",
  "25%",
  "30%",
  "35%",
  "40%",
  "45%",
  "50%",
  "55%",
  "60%",
  "65%",
  "70%",
  "75%",
  "80%",
  "85%",
  "90%",
  "95%",
  "100%",
];

const camelToNormal = (text: string) => {
  return text
    .replace(/([A-Z])/g, " $1")
    .replace(/^./, (str) => str.toUpperCase());
};

const PlanAndCoverage: React.FC<ChildComponentProps> = ({
  fields,
  setFields,
  savedQuotation,
  savedTransaction,
}) => {
  let jsonData;
  let headers: any[] = [];
  let OptRiderData;
  let OptHeaders: any[] = [];

  const [selectedRiders, setSelectedRiders] = useState<string[]>([]);
  const [loading, setLoading] = useState(false);
  const [premiumResponse, setPremiumResponse] = useState<any>(null);
  const [error, setError] = useState<string | null>(null);

  const handleFieldChange = (val: string, fieldName: string) => {
    setFields({ ...fields, [fieldName]: val });
  };

  const handlePlanChange = (event: SelectChangeEvent<string>) => {
    const selectedPlan = event.target.value;
    handleFieldChange(selectedPlan, "basicPlan");

    // Set default values based on plan type
    const defaultSumInsured = getDefaultSumInsured(selectedPlan);
    const defaultPremium = calculatePremium(defaultSumInsured, selectedPlan);

    handleFieldChange(defaultSumInsured.toString(), "basicSumInsured");
    handleFieldChange(defaultPremium.toString(), "basicPlanPremium");
  };

  const getDefaultSumInsured = (planType: string): number => {
    switch (planType) {
      case "Term Insurance":
        return 1000000;
      case "Whole Life Insurance":
        return 500000;
      case "Universal Life Insurance":
        return 750000;
      case "Endowment Plan":
        return 300000;
      default:
        return 500000;
    }
  };

  const calculatePremium = (sumInsured: number, planType: string): number => {
    const baseRate = {
      "Term Insurance": 0.002,
      "Whole Life Insurance": 0.015,
      "Universal Life Insurance": 0.012,
      "Endowment Plan": 0.025,
    };
    return Math.round(
      sumInsured *
        (baseRate[planType as keyof typeof baseRate] || 0.01)
    );
  };

  const handleRiderChange = (event: SelectChangeEvent<string[]>) => {
    const value = event.target.value;
    setSelectedRiders(typeof value === "string" ? value.split(",") : value);
  };

  const { t } = useTranslation();

  useEffect(() => {
    if (savedTransaction && savedTransaction.length > 0) {
      const baseSA = savedTransaction[0]?.txn_input_json?.Base_SA;
      const plan = savedTransaction[0]?.txn_input_json?.Plan;
      const term = savedTransaction[0]?.txn_input_json["SSPP.Policy_Term"];
      const ppt = savedTransaction[0]?.txn_input_json?.PPT;

      setFields((prevFields) => ({
        ...prevFields,
        basicPlanPremium:
          savedTransaction[0]?.txn_output_json?.outputs?.PremiumSummary?.[1]
            ?.basePlan ?? prevFields.basicPlanPremium,
        basicSumInsured: baseSA || prevFields.basicSumInsured || "200000",
        basicPlan: plan ?? prevFields.basicPlan,
        insuranceTerm: term ?? prevFields.insuranceTerm,
        ppt: ppt ?? prevFields.ppt,
        typeOfDivident: "Non - Participatory",
        Product: prevFields.Product ?? "",
        Policy_Inception_Date:
          prevFields.Policy_Inception_Date ??
          new Date().toISOString().split("T")[0],
        Smoker: prevFields.Smoker ?? "No",
        Pre_Existing_Disease: prevFields.Pre_Existing_Disease ?? "Yes",
        Extra_mortality: prevFields.Extra_mortality ?? "75%",
        Policy_Term: prevFields.Policy_Term ?? "45",
        Mandatory_Premium_Period:
          prevFields.Mandatory_Premium_Period ?? "ErrName",
        PAV: prevFields.PAV ?? "0",
        per_mille_rating_death: prevFields.per_mille_rating_death ?? "1",
        per_mille_rating_TPD: prevFields.per_mille_rating_TPD ?? "1",
        per_mille_rating_SCI: prevFields.per_mille_rating_SCI ?? "1",
        Death_Benefit: prevFields.Death_Benefit ?? "Yes",
        Total_and_Permanent_Disability_TPD:
          prevFields.Total_and_Permanent_Disability_TPD ?? "Yes",
        Accidental_Death_and_Dismemberment_ADD:
          prevFields.Accidental_Death_and_Dismemberment_ADD ?? "Yes",
        Staged_Critical_Illness_SCI:
          prevFields.Staged_Critical_Illness_SCI ?? "Yes",
        _2e_Hospital_Cash_Benefit_HCB:
          prevFields._2e_Hospital_Cash_Benefit_HCB ?? "Y",
        Partial_Withdrawl: prevFields.Partial_Withdrawl ?? "Yes",
        Partial_Withdrawl_Amount:
          prevFields.Partial_Withdrawl_Amount ?? "5000",
      }));
    } else {
      // defaults
      setFields((prevFields) => ({
        ...prevFields,
        basicSumInsured: prevFields.basicSumInsured ?? "200000",
        Product: prevFields.Product ?? "",
        Policy_Inception_Date:
          prevFields.Policy_Inception_Date ??
          new Date().toISOString().split("T")[0],
        Smoker: prevFields.Smoker ?? "No",
        Pre_Existing_Disease: prevFields.Pre_Existing_Disease ?? "Yes",
        Extra_mortality: prevFields.Extra_mortality ?? "75%",
        Policy_Term: prevFields.Policy_Term ?? "45",
        Mandatory_Premium_Period:
          prevFields.Mandatory_Premium_Period ?? "ErrName",
        PAV: prevFields.PAV ?? "0",
        per_mille_rating_death: prevFields.per_mille_rating_death ?? "1",
        per_mille_rating_TPD: prevFields.per_mille_rating_TPD ?? "1",
        per_mille_rating_SCI: prevFields.per_mille_rating_SCI ?? "1",
        Death_Benefit: prevFields.Death_Benefit ?? "Yes",
        Total_and_Permanent_Disability_TPD:
          prevFields.Total_and_Permanent_Disability_TPD ?? "Yes",
        Accidental_Death_and_Dismemberment_ADD:
          prevFields.Accidental_Death_and_Dismemberment_ADD ?? "Yes",
        Staged_Critical_Illness_SCI:
          prevFields.Staged_Critical_Illness_SCI ?? "Yes",
        _2e_Hospital_Cash_Benefit_HCB:
          prevFields._2e_Hospital_Cash_Benefit_HCB ?? "Y",
        Partial_Withdrawl: prevFields.Partial_Withdrawl ?? "Yes",
        Partial_Withdrawl_Amount:
          prevFields.Partial_Withdrawl_Amount ?? "5000",
      }));
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [savedTransaction]);

  if (
    savedTransaction &&
    typeof savedTransaction === "object" &&
    Object.keys(savedTransaction).length !== 0
  ) {
    jsonData = savedTransaction[0]?.txn_output_json?.outputs?.RiderDetails;
    if (jsonData?.length) {
      headers = Object.keys(jsonData[0]);
    }
    OptRiderData =
      savedTransaction[0]?.txn_output_json?.outputs?.OptionalBenefitDetails;
    if (OptRiderData?.length) {
      OptHeaders = Object.keys(OptRiderData[0]);
    }
  }

  // ---------------------------
  // Build request and call backend premium API
  // ---------------------------
  const getPremium = async () => {
    setLoading(true);
    setError(null);
    setPremiumResponse(null);

    try {
      // Try to get DOB/Gender/Occupation from localStorage as fallback (LifeAssured page should save these)
      const dob =
        localStorage.getItem("insuredDob") || localStorage.getItem("DOB_LI") || "";
      const gender =
        localStorage.getItem("insuredGender") ||
        localStorage.getItem("Gender_LI") ||
        "Male";
      const occupation =
        Number(localStorage.getItem("occupation")) ||
        Number(localStorage.getItem("occupationCode")) ||
        4;

      // Extra mortality: '75%' -> 0.75
      const extraMortRaw = fields.Extra_mortality || "0%";
      const extraMort = Number(
        (extraMortRaw as string).toString().replace("%", "")
      );
      const extraMortDecimal = isNaN(extraMort) ? 0 : extraMort / 100;

      const requestBody = {
        request_data: {
          inputs: {
            _1a_DOB: dob || "", // life assured DOB
            _1b_Product: fields.basicPlan || "Option A",
            _1c_Gender: gender || "Male",
            _1d_Face_Amount: Number(fields.basicSumInsured) || 0,
            _1e_Occupation: occupation || 4,
            _1h_Policy_Inception_Date:
              fields.Policy_Inception_Date || new Date().toISOString().split("T")[0],
            _1i_Smoker: (fields.Smoker === "Yes" ? "Y" : "N") || "N",
            _1j_Pre_Existing_Disease:
              fields.Pre_Existing_Disease === "Yes" ? "Y" : "N",
            _1k_Extra_mortality: extraMortDecimal,
            _1p_Policy_Term: Number(fields.Policy_Term) || 0,
            _1r_Mandatory_Premium_Period: fields.Mandatory_Premium_Period || "",
            // hard coded defaults:
            _1zb_PAV: 0,
            _1zc_per_mille_rating_death: 1,
            _1zd_per_mille_rating_TPD: 1,
            _1ze_per_mille_rating_SCI: 1,
            _2a_Death_Benefit: fields.Death_Benefit || "Y",
            _2b_Total_and_Permanent_Disability_TPD:
              fields.Total_and_Permanent_Disability_TPD || "Y",
            _2c_Accidental_Death_and_Dismemberment_ADD:
              fields.Accidental_Death_and_Dismemberment_ADD || "Y",
            _2d_Staged_Critical_Illness_SCI:
              fields.Staged_Critical_Illness_SCI || "Y",
            _2e_Hospital_Cash_Benefit_HCB:
              fields._2e_Hospital_Cash_Benefit_HCB || "Y",
            _3a_Partial_Withdrawl: fields.Partial_Withdrawl || "Y",
            _3b_Partial_Withdrawl_Amount:
              Number(fields.Partial_Withdrawl_Amount) || 5000,
          },
        },
        request_meta: {
          version_id: "57e38b87-052c-4fb1-a6c5-76bd1567df2d",
          call_purpose: "Spark - API Tester",
          source_system: "SPARK",
          correlation_id: null,
          requested_output: null,
          service_category: "",
        },
      };

      const url = "http://localhost:8001/api/calc/premium";

      const response = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(requestBody),
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(
          `HTTP ${response.status} - ${response.statusText} - ${text}`
        );
      }

      const data = await response.json();
      setPremiumResponse(data);

      // Try to extract basic plan premium if present in response (best-effort)
      // different engines return different paths; try common ones
      const maybePremium =
        data?.response_data?.outputs?.PremiumSummary?.[0]?.basePlan ??
        data?.response_data?.outputs?.PremiumSummary ??
        data?.response_data?.outputs?.TotalPremium ??
        data?.response_data?.outputs?.Total_Premium ??
        data?.response_data?.outputs?.premium ??
        null;

      if (maybePremium !== null && maybePremium !== undefined) {
        // convert to string
        setFields((prev) => ({ ...prev, basicPlanPremium: String(maybePremium) }));
      }

      setLoading(false);
    } catch (err: any) {
      setError(err?.message || "Error fetching premium");
      setLoading(false);
    }
  };

  return (
    <Box sx={{ width: "100%", padding: 2 }}>
      {/* Quotation Summary */}
      <Paper elevation={3} sx={{ marginBottom: 2, padding: 2 }}>
        <Typography className="typography-main-header">
          {t("quotation_summaryh")}
        </Typography>
        <Divider />
        <Box
          sx={{
            display: "flex",
            flexDirection: { xs: "column", sm: "row" },
            marginTop: 2,
            alignItems: "center",
            justifyContent: "space-between",
            gap: 2,
          }}
        >
          <Box>
            <Typography component="span">{t("quotation_summary")}&emsp;</Typography>
            <Link
              underline="always"
              color="inherit"
              sx={{ color: "#000048" }}
              onClick={() => {
                if (!savedQuotation?.txn_pdf) {
                  return;
                }
                const file = new Blob(
                  [
                    Uint8Array.from(atob(savedQuotation.txn_pdf), (c) =>
                      c.charCodeAt(0)
                    ),
                  ],
                  {
                    type: "application/pdf",
                  }
                );
                const fileURL = URL.createObjectURL(file);
                window.open(fileURL);
              }}
            >
              Download Link to Quotation
            </Link>
          </Box>

          {/* Calculate Premium Button */}
          <Box sx={{ display: "flex", alignItems: "center", gap: 2 }}>
            <Button
              variant="contained"
              onClick={getPremium}
              disabled={loading}
            >
              {loading ? <CircularProgress size={20} /> : "Calculate Premium"}
            </Button>
          </Box>
        </Box>
      </Paper>

      {/* Main Plan */}
      <Paper elevation={3} sx={{ marginBottom: 2, padding: 2 }}>
        <Typography className="typography-main-header">
          {t("main_plan")}
        </Typography>
        <Divider />
        <Box sx={{ marginTop: 2 }}>
          <TableContainer sx={{ width: "100%" }}>
            <Table className="table-main" sx={{ width: "100%" }}>
              <TableBody>
                <TableRow sx={{ display: "flex", flexWrap: "wrap" }}>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>{t("basicPlan")}</InputLabel>
                      <Select value={fields.basicPlan} onChange={handlePlanChange}>
                        {MAIN_PLANS.map((plan) => (
                          <MenuItem key={plan} value={plan}>
                            {plan}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>

                  {[
                    "basicSumInsured",
                    "basicPlanPremium",
                    "typeOfDivident",
                    "insuranceTerm",
                    "ppt",
                  ].map((field) => (
                    <TableCell
                      key={field}
                      sx={{ flex: "1 1 30%", minWidth: "120px" }}
                    >
                      <TextField
                        size="small"
                        label={t(field)}
                        variant="standard"
                        InputProps={{ readOnly: true }}
                        value={fields[field as keyof typeof fields]}
                        onChange={(e) => handleFieldChange(e.target.value, field)}
                      />
                    </TableCell>
                  ))}

                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>Product</InputLabel>
                      <Select
                        value={fields.Product}
                        onChange={(e) => handleFieldChange(e.target.value, "Product")}
                      >
                        {PRODUCT_OPTIONS.map((option) => (
                          <MenuItem key={option} value={option}>
                            {option}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>

                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <TextField
                      size="small"
                      label="Policy Inception Date"
                      variant="standard"
                      type="date"
                      value={fields.Policy_Inception_Date}
                      onChange={(e) =>
                        handleFieldChange(e.target.value, "Policy_Inception_Date")
                      }
                    />
                  </TableCell>

                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>Smoker</InputLabel>
                      <Select
                        value={fields.Smoker}
                        onChange={(e) => handleFieldChange(e.target.value, "Smoker")}
                      >
                        {YES_NO.map((option) => (
                          <MenuItem key={option} value={option}>
                            {option}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>

                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>Pre Existing Disease</InputLabel>
                      <Select
                        value={fields.Pre_Existing_Disease}
                        onChange={(e) =>
                          handleFieldChange(e.target.value, "Pre_Existing_Disease")
                        }
                      >
                        {YES_NO.map((option) => (
                          <MenuItem key={option} value={option}>
                            {option}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>

                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>Extra Mortality</InputLabel>
                      <Select
                        value={fields.Extra_mortality}
                        onChange={(e) =>
                          handleFieldChange(e.target.value, "Extra_mortality")
                        }
                      >
                        {EXTRA_MORTALITY_OPTIONS.map((option) => (
                          <MenuItem key={option} value={option}>
                            {option}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>

                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <TextField
                      size="small"
                      label="Policy Term"
                      variant="standard"
                      value={fields.Policy_Term}
                      onChange={(e) => handleFieldChange(e.target.value, "Policy_Term")}
                    />
                  </TableCell>

                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <TextField
                      size="small"
                      label="Mandatory Premium Period"
                      variant="standard"
                      value={fields.Mandatory_Premium_Period}
                      onChange={(e) =>
                        handleFieldChange(e.target.value, "Mandatory_Premium_Period")
                      }
                    />
                  </TableCell>
                </TableRow>
              </TableBody>
            </Table>
          </TableContainer>
        </Box>
      </Paper>

      {/* Riders */}
      <Paper elevation={3} sx={{ marginBottom: 2, padding: 2 }}>
        <Typography className="typography-main-header">{t("riders")}</Typography>
        <Divider />
        <Box sx={{ marginTop: 2 }}>
          <FormControl
            variant="standard"
            size="small"
            sx={{ minWidth: 200, marginBottom: 2 }}
          >
            <InputLabel>Select Riders</InputLabel>
            <Select
              multiple
              value={selectedRiders}
              onChange={handleRiderChange}
              renderValue={(selected) => selected.join(", ")}
            >
              {RIDERS.map((rider) => (
                <MenuItem key={rider} value={rider}>
                  {rider}
                </MenuItem>
              ))}
            </Select>
          </FormControl>

          {jsonData && (
            <TableContainer sx={{ width: "100%" }}>
              <Table sx={{ width: "100%" }}>
                <TableHead>
                  <TableRow>
                    {headers?.map((header) => (
                      <TableCell key={header}>{camelToNormal(header)}</TableCell>
                    ))}
                  </TableRow>
                </TableHead>
                <TableBody>
                  {jsonData?.map((row: any, rowIndex: number) => (
                    <TableRow key={rowIndex}>
                      {headers?.map((header) => (
                        <TableCell key={header}>{row[header]}</TableCell>
                      ))}
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </TableContainer>
          )}
        </Box>
      </Paper>

      {/* Optional Benefits */}
      <Paper elevation={3} sx={{ marginBottom: 2, padding: 2 }}>
        <Typography className="typography-main-header">
          {t("optional_benefits")}
        </Typography>
        <Divider />
        <Box sx={{ marginTop: 2 }}>
          <TableContainer sx={{ width: "100%" }}>
            <Table sx={{ width: "100%" }}>
              <TableHead>
                <TableRow>
                  {OptHeaders?.map((header) => (
                    <TableCell key={header}>{camelToNormal(header)}</TableCell>
                  ))}
                </TableRow>
              </TableHead>
              <TableBody>
                {OptRiderData?.map((row: any, rowIndex: number) => (
                  <TableRow key={rowIndex}>
                    {OptHeaders?.map((header) => (
                      <TableCell key={header}>{row[header]}</TableCell>
                    ))}
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        </Box>
      </Paper>

      {/* Premium Response */}
      <Box sx={{ mt: 2 }}>
        {loading && (
          <Paper sx={{ p: 2 }}>
            <Typography>Calculating premium...</Typography>
          </Paper>
        )}

        {error && (
          <Alert severity="error" sx={{ mb: 2 }}>
            {error}
          </Alert>
        )}

        {premiumResponse && (
          <Paper sx={{ p: 2 }}>
            <Typography variant="h6">Premium Response</Typography>
            <pre
              style={{
                whiteSpace: "pre-wrap",
                wordBreak: "break-word",
                maxHeight: 300,
                overflow: "auto",
                marginTop: 8,
              }}
            >
              {JSON.stringify(premiumResponse, null, 2)}
            </pre>
          </Paper>
        )}
      </Box>
    </Box>
  );
};

export default PlanAndCoverage;


---

काय करावं नंतर (important):

1. तुझ्या LifeAssured पेजवर DOB, Gender, Occupation (आदि) localStorage.setItem('insuredDob', value) वगैरे राखले की हे request पूर्ण होईल. मी localStorage वापरलीय fallback साठी.


2. Backend चालू असावा: http://localhost:8001/api/calc/premium — ही endpoint तुझ्या backend मध्ये असावी (तू आधी सांगितलेली).


3. जर backend वेगळे response path वापरत असेल, मी maybePremium extraction बहुदा आढळे तिथे update करतो. आवडल्यास response format सांगेल तर मी direct fields.basicPlanPremium मध्ये नक्की set करेन.



जर तुला हवे तर आता मी LifeAssuredDetail.tsx मध्येही localStorage.setItem lines add करून देऊ — म्हणजे LifeAssured भरला की DOB/Gender/Occupation auto-save होईल. माझं करावं का? (जर करायचं असेल तर मी तेही एकदम copy-paste ready देतो.)

हळूच सां — मी पुढे LifeAssured auto-save update करतो का?













import {
  Box,
  Divider,
  Link,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  TextField,
  Typography,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  SelectChangeEvent,
} from "@mui/material";

import React, { useEffect, useState } from "react";

import { useTranslation } from "react-i18next";

interface ChildComponentProps {
  fields: {
    basicPlan: string;

    basicSumInsured: string;

    basicPlanPremium: string;

    typeOfDivident: string;

    insuranceTerm: string;

    ppt: string;

    Product: string;

    Policy_Inception_Date: string;

    Smoker: string;

    Pre_Existing_Disease: string;

    Extra_mortality: string;

    Policy_Term: string;

    Mandatory_Premium_Period: string;

    PAV: string;

    per_mille_rating_death: string;

    per_mille_rating_TPD: string;

    per_mille_rating_SCI: string;

    Death_Benefit: string;

    Total_and_Permanent_Disability_TPD: string;

    Accidental_Death_and_Dismemberment_ADD: string;

    Staged_Critical_Illness_SCI: string;

    _2e_Hospital_Cash_Benefit_HCB: string;

    Partial_Withdrawl: string;

    Partial_Withdrawl_Amount: string;
  };

  setFields: React.Dispatch<
    React.SetStateAction<{
      basicPlan: string;

      basicSumInsured: string;

      basicPlanPremium: string;

      typeOfDivident: string;

      insuranceTerm: string;

      ppt: string;

      Product: string;

      Policy_Inception_Date: string;

      Smoker: string;

      Pre_Existing_Disease: string;

      Extra_mortality: string;

      Policy_Term: string;

      Mandatory_Premium_Period: string;

      PAV: string;

      per_mille_rating_death: string;

      per_mille_rating_TPD: string;

      per_mille_rating_SCI: string;

      Death_Benefit: string;

      Total_and_Permanent_Disability_TPD: string;

      Accidental_Death_and_Dismemberment_ADD: string;

      Staged_Critical_Illness_SCI: string;

      _2e_Hospital_Cash_Benefit_HCB: string;

      Partial_Withdrawl: string;

      Partial_Withdrawl_Amount: string;
    }>
  >;

  savedQuotation: any;

  savedTransaction: any;
}

const MAIN_PLANS = [
  "Term Insurance",
  "Whole Life Insurance", 
  "Universal Life Insurance",
  "Endowment Plan"
];

const RIDERS = [
  "ADD",
  "CI",
  "WOP",
  "HCB",
  "DB"
];

const YES_NO = ["Yes", "No"];

const PRODUCT_OPTIONS = ["a", "b"];

const EXTRA_MORTALITY_OPTIONS = ["5%", "10%", "15%", "20%", "25%", "30%", "35%", "40%", "45%", "50%", "55%", "60%", "65%", "70%", "75%", "80%", "85%", "90%", "95%", "100%"];

const camelToNormal = (text: string) => {
  return text
    .replace(/([A-Z])/g, " $1")
    .replace(/^./, (str) => str.toUpperCase());
};

const PlanAndCoverage: React.FC<ChildComponentProps> = ({
  fields,

  setFields,

  savedQuotation,

  savedTransaction,
}) => {
  let jsonData;

  let headers: any[] = [];

  let OptRiderData;

  let OptHeaders: any[] = [];

  const [selectedRiders, setSelectedRiders] = useState<string[]>([]);

  const handleFieldChange = (val: string, fieldName: string) => {
    setFields({ ...fields, [fieldName]: val });
  };

  const handlePlanChange = (event: SelectChangeEvent<string>) => {
    const selectedPlan = event.target.value;
    handleFieldChange(selectedPlan, "basicPlan");
    
    // Set default values based on plan type
    const defaultSumInsured = getDefaultSumInsured(selectedPlan);
    const defaultPremium = calculatePremium(defaultSumInsured, selectedPlan);
    
    handleFieldChange(defaultSumInsured.toString(), "basicSumInsured");
    handleFieldChange(defaultPremium.toString(), "basicPlanPremium");
  };

  const getDefaultSumInsured = (planType: string): number => {
    switch (planType) {
      case "Term Insurance": return 1000000;
      case "Whole Life Insurance": return 500000;
      case "Universal Life Insurance": return 750000;
      case "Endowment Plan": return 300000;
      default: return 500000;
    }
  };

  const calculatePremium = (sumInsured: number, planType: string): number => {
    const baseRate = {
      "Term Insurance": 0.002,
      "Whole Life Insurance": 0.015,
      "Universal Life Insurance": 0.012,
      "Endowment Plan": 0.025
    };
    return Math.round(sumInsured * (baseRate[planType as keyof typeof baseRate] || 0.01));
  };

  const handleRiderChange = (event: SelectChangeEvent<string[]>) => {
    const value = event.target.value;
    setSelectedRiders(typeof value === 'string' ? value.split(',') : value);
  };

  const { t } = useTranslation();

  useEffect(() => {
    if (savedTransaction && savedTransaction.length > 0) {
      const baseSA = savedTransaction[0]?.txn_input_json?.Base_SA;

      const plan = savedTransaction[0]?.txn_input_json?.Plan;

      const term = savedTransaction[0]?.txn_input_json["SSPP.Policy_Term"];

      const ppt = savedTransaction[0]?.txn_input_json?.PPT;

      setFields((prevFields) => ({
        ...prevFields,

        basicPlanPremium:
          savedTransaction[0]?.txn_output_json?.outputs?.PremiumSummary[1]
            ?.basePlan,

        basicSumInsured: baseSA || '200000',

        basicPlan: plan,

        insuranceTerm: term,

        ppt: ppt,

        typeOfDivident: "Non - Participatory",

        Product: '',

        Policy_Inception_Date: new Date().toISOString().split('T')[0],

        Smoker: 'No',

        Pre_Existing_Disease: 'Yes',

        Extra_mortality: '75%',

        Policy_Term: '45',

        Mandatory_Premium_Period: 'ErrName',

        PAV: '0',

        per_mille_rating_death: '1',

        per_mille_rating_TPD: '1',

        per_mille_rating_SCI: '1',

        Death_Benefit: 'Yes',

        Total_and_Permanent_Disability_TPD: 'Yes',

        Accidental_Death_and_Dismemberment_ADD: 'Yes',

        Staged_Critical_Illness_SCI: 'Yes',

        _2e_Hospital_Cash_Benefit_HCB: 'Y',

        Partial_Withdrawl: 'Yes',

        Partial_Withdrawl_Amount: '5000',
      }));
    } else {
      // Set defaults when no savedTransaction
      setFields((prevFields) => ({
        ...prevFields,

        basicSumInsured: '200000',

        Product: '',

        Policy_Inception_Date: new Date().toISOString().split('T')[0],

        Smoker: 'No',

        Pre_Existing_Disease: 'Yes',

        Extra_mortality: '75%',

        Policy_Term: '45',

        Mandatory_Premium_Period: 'ErrName',

        PAV: '0',

        per_mille_rating_death: '1',

        per_mille_rating_TPD: '1',

        per_mille_rating_SCI: '1',

        Death_Benefit: 'Yes',

        Total_and_Permanent_Disability_TPD: 'Yes',

        Accidental_Death_and_Dismemberment_ADD: 'Yes',

        Staged_Critical_Illness_SCI: 'Yes',

        _2e_Hospital_Cash_Benefit_HCB: 'Y',

        Partial_Withdrawl: 'Yes',

        Partial_Withdrawl_Amount: '5000',
      }));
    }
  }, [savedTransaction]);

  if (
    savedTransaction &&
    typeof savedTransaction === "object" &&
    Object.keys(savedTransaction).length !== 0
  ) {
    jsonData = savedTransaction[0]?.txn_output_json?.outputs?.RiderDetails;

    if (jsonData?.length) {
      headers = Object.keys(jsonData[0]);
    }

    OptRiderData =
      savedTransaction[0]?.txn_output_json?.outputs?.OptionalBenefitDetails;

    if (OptRiderData?.length) {
      OptHeaders = Object.keys(OptRiderData[0]);
    }
  }

  return (
    <Box sx={{ width: "100%", padding: 2 }}>
      {/* Quotation Summary */}
      <Paper elevation={3} sx={{ marginBottom: 2, padding: 2 }}>
        <Typography className="typography-main-header">
          {t("quotation_summaryh")}
        </Typography>
        <Divider />
        <Box
          sx={{
            display: "flex",
            flexDirection: { xs: "column", sm: "row" },
            marginTop: 2,
          }}
        >
          <Typography>{t("quotation_summary")}&emsp;</Typography>
          <Link
            underline="always"
            color="inherit"
            sx={{ color: "#000048" }}
            onClick={() => {
              const file = new Blob(
                [
                  Uint8Array.from(atob(savedQuotation.txn_pdf), (c) =>
                    c.charCodeAt(0)
                  ),
                ],
                {
                  type: "application/pdf",
                }
              );

              const fileURL = URL.createObjectURL(file);

              window.open(fileURL);
            }}
          >
            Download Link to Quotation
          </Link>
        </Box>
      </Paper>

      {/* Main Plan */}
      <Paper elevation={3} sx={{ marginBottom: 2, padding: 2 }}>
        <Typography className="typography-main-header">
          {t("main_plan")}
        </Typography>
        <Divider />
        <Box sx={{ marginTop: 2 }}>
          <TableContainer sx={{ width: "100%" }}>
            <Table className="table-main" sx={{ width: "100%" }} >
              <TableBody>
                <TableRow sx={{ display: "flex", flexWrap: "wrap" }}>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>{t("basicPlan")}</InputLabel>
                      <Select
                        value={fields.basicPlan}
                        onChange={handlePlanChange}
                      >
                        {MAIN_PLANS.map((plan) => (
                          <MenuItem key={plan} value={plan}>
                            {plan}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>
                  {["basicSumInsured", "basicPlanPremium", "typeOfDivident", "insuranceTerm", "ppt"].map((field) => (
                    <TableCell
                      key={field}
                      sx={{ flex: "1 1 30%", minWidth: "120px" }}
                    >
                      <TextField
                        size="small"
                        label={t(field)}
                        variant="standard"
                        InputProps={{ readOnly: true }}
                        value={fields[field as keyof typeof fields]}
                        onChange={(e) =>
                          handleFieldChange(e.target.value, field)
                        }
                      />
                    </TableCell>
                  ))}
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>Product</InputLabel>
                      <Select
                        value={fields.Product}
                        onChange={(e) => handleFieldChange(e.target.value, "Product")}
                      >
                        {PRODUCT_OPTIONS.map((option) => (
                          <MenuItem key={option} value={option}>
                            {option}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <TextField
                      size="small"
                      label="Policy Inception Date"
                      variant="standard"
                      type="date"
                      value={fields.Policy_Inception_Date}
                      onChange={(e) => handleFieldChange(e.target.value, "Policy_Inception_Date")}
                    />
                  </TableCell>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>Smoker</InputLabel>
                      <Select
                        value={fields.Smoker}
                        onChange={(e) => handleFieldChange(e.target.value, "Smoker")}
                      >
                        {YES_NO.map((option) => (
                          <MenuItem key={option} value={option}>
                            {option}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>Pre Existing Disease</InputLabel>
                      <Select
                        value={fields.Pre_Existing_Disease}
                        onChange={(e) => handleFieldChange(e.target.value, "Pre_Existing_Disease")}
                      >
                        {YES_NO.map((option) => (
                          <MenuItem key={option} value={option}>
                            {option}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>Extra Mortality</InputLabel>
                      <Select
                        value={fields.Extra_mortality}
                        onChange={(e) => handleFieldChange(e.target.value, "Extra_mortality")}
                      >
                        {EXTRA_MORTALITY_OPTIONS.map((option) => (
                          <MenuItem key={option} value={option}>
                            {option}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <TextField
                      size="small"
                      label="Policy Term"
                      variant="standard"
                      value={fields.Policy_Term}
                      onChange={(e) => handleFieldChange(e.target.value, "Policy_Term")}
                    />
                  </TableCell>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <TextField
                      size="small"
                      label="Mandatory Premium Period"
                      variant="standard"
                      value={fields.Mandatory_Premium_Period}
                      onChange={(e) => handleFieldChange(e.target.value, "Mandatory_Premium_Period")}
                    />
                  </TableCell>
                </TableRow>
              </TableBody>
            </Table>
          </TableContainer>
        </Box>
      </Paper>

      {/* Riders */}
      <Paper elevation={3} sx={{ marginBottom: 2, padding: 2 }}>
        <Typography className="typography-main-header">
          {t("riders")}
        </Typography>
        <Divider />
        <Box sx={{ marginTop: 2 }}>
          <FormControl variant="standard" size="small" sx={{ minWidth: 200, marginBottom: 2 }}>
            <InputLabel>Select Riders</InputLabel>
            <Select
              multiple
              value={selectedRiders}
              onChange={handleRiderChange}
              renderValue={(selected) => selected.join(', ')}
            >
              {RIDERS.map((rider) => (
                <MenuItem key={rider} value={rider}>
                  {rider}
                </MenuItem>
              ))}
            </Select>
          </FormControl>
          {jsonData && (
            <TableContainer sx={{ width: "100%" }}>
              <Table sx={{ width: "100%" }}>
                <TableHead>
                  <TableRow>
                    {headers?.map((header) => (
                      <TableCell key={header}>{camelToNormal(header)}</TableCell>
                    ))}
                  </TableRow>
                </TableHead>
                <TableBody>
                  {jsonData?.map((row: any, rowIndex: number) => (
                    <TableRow key={rowIndex}>
                      {headers?.map((header) => (
                        <TableCell key={header}>{row[header]}</TableCell>
                      ))}
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </TableContainer>
          )}
        </Box>
      </Paper>

      {/* Optional Benefits */}
      <Paper elevation={3} sx={{ marginBottom: 2, padding: 2 }}>
        <Typography className="typography-main-header">
          {t("optional_benefits")}
        </Typography>
        <Divider />
        <Box sx={{ marginTop: 2 }}>
          <TableContainer sx={{ width: "100%" }}>
            <Table sx={{ width: "100%" }}>
              <TableHead>
                <TableRow>
                  {OptHeaders?.map((header) => (
                    <TableCell key={header}>{camelToNormal(header)}</TableCell>
                  ))}
                </TableRow>
              </TableHead>
              <TableBody>
                {OptRiderData?.map((row: any, rowIndex: number) => (
                  <TableRow key={rowIndex}>
                    {OptHeaders?.map((header) => (
                      <TableCell key={header}>{row[header]}</TableCell>
                    ))}
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        </Box>
      </Paper>
    </Box>
  );
};

export default PlanAndCoverage;
