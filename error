import React, { useState, useEffect } from 'react';
import { 
  Box, Paper, Typography, Grid, TextField, 
  Button, Stack, IconButton, CircularProgress, 
  Table, TableBody, TableCell, TableContainer, TableHead, TableRow,
  MenuItem, Select, FormControl, InputLabel, Chip, Divider,
  Checkbox
} from '@mui/material';
import { ArrowBack, Person, Assignment, LocalHospital, Assessment, Gavel } from '@mui/icons-material';
import { useParams, useNavigate } from 'react-router-dom';
import axios from '../../api/axiosInterceptor';
import dayjs from 'dayjs';
import DecisionModal, { PolicyProduct } from './DecisionModal'; // Import the type from child

// --- Interfaces ---
interface ApiRecord {
  quotation_id: string;
  screen_No: number;
  json_DATA: string;
  creation_TIME: string;
  version_NO: number;
}

interface UnderwritingCase {
  uwCode: string;
  creationDate: string;
  applicantName: string;
  serviceType: string;
  appNumber: string;
  policyNumber: string;
  agentCode: string;
  branch: string;
  productName: string;
  email: string;
  mobile: string;
  dob: string;
  gender: string;
  heightWeight: string; 
  occupation: string;
  income: string;
  sumAssured: string;
  premium: string;
  address: string;
  occLevelLife: string;
  occLevelAccident: string;
  occLevelHealth: string;
  tpdExposure: string;
  medicalReport: string;
}

interface PolicyRow {
    id: string;
    productName: string;
    sumAssured: string;
    premium: string;
    status: string;
}

// --- MAIN PAGE COMPONENT ---
const UnderwritingDetails: React.FC = () => {
  const { txnTypeId } = useParams();
  const navigate = useNavigate();
  
  const [loading, setLoading] = useState(true);
  const [caseData, setCaseData] = useState<UnderwritingCase | null>(null);
  
  // Controls Modal Visibility
  const [openModal, setOpenModal] = useState(false);
  const [comments, setComments] = useState('');

  // --- NEW STATE VARIABLES ---
  // 1. Risk Dropdown States
  const [riskValues, setRiskValues] = useState({
    life: '',
    accident: '',
    health: ''
  });

  // 2. Table Data and Selection States
  const [policyList, setPolicyList] = useState<PolicyRow[]>([]);
  const [selectedPolicyIds, setSelectedPolicyIds] = useState<string[]>([]);

  useEffect(() => {
    if (!txnTypeId) {
      setLoading(false);
      return;
    }

    const fetchData = async () => {
      setLoading(true);
      try {
        const response = await axios.get<ApiRecord[]>('http://localhost:8001/eapp/getAll');
        const allRecords = response.data;
        const matchingRecords = allRecords.filter(item => item.quotation_id === txnTypeId);

        if (matchingRecords.length === 0) {
            setCaseData(null);
            return;
        }

        const screens: { [key: number]: any } = {};
        let creationTime = '';

        matchingRecords.forEach(rec => {
            if (!creationTime || new Date(rec.creation_TIME) > new Date(creationTime)) {
                creationTime = rec.creation_TIME;
            }
            const currentStored = screens[rec.screen_No];
            if (!currentStored || rec.version_NO > currentStored.version_NO) {
                try {
                    const parsedData = typeof rec.json_DATA === 'string' ? JSON.parse(rec.json_DATA) : rec.json_DATA;
                    screens[rec.screen_No] = { ...rec, parsedData };
                } catch (e) {
                    console.error(`Error parsing JSON for Screen ${rec.screen_No}`, e);
                }
            }
        });

        const s1 = screens[1]?.parsedData || {};
        const s2 = screens[2]?.parsedData || {};
        const s3 = screens[3]?.parsedData || {};
        const s10 = screens[10]?.parsedData || {};

        const mapped: UnderwritingCase = {
          uwCode: `UW-${txnTypeId}`,
          creationDate: creationTime ? dayjs(creationTime).format('DD MMM YYYY') : '-',
          applicantName: `${s1.insuredFirstName || ''} ${s1.insuredSurName || ''}`.trim() || 'Unknown',
          serviceType: 'New Business',
          appNumber: txnTypeId,
          policyNumber: 'PENDING-001', 
          agentCode: 'AG-1029 (Direct)', 
          branch: 'Head Office',
          productName: s2.basicPlan || 'General Life Plan',
          email: s1.emailAddress || '-',
          mobile: s1.primaryNumber || s1.workPhoneNumber || '-',
          dob: s1.insuredDateOfBirth ? dayjs(s1.insuredDateOfBirth).format('DD/MM/YYYY') : '-',
          gender: s1.insuredGender || '-',
          heightWeight: 'N/A', 
          occupation: s1.occupationCode || s1.occupationDetail || 'N/A',
          income: s1.annualIncome ? `INR ${Number(s1.annualIncome).toLocaleString()}` : '-',
          sumAssured: s2.basicSumInsured ? `${Number(s2.basicSumInsured).toLocaleString()}` : '0',
          premium: (s10.annualPremium || s3.AmountOfPaymentWithThisApplication) ? `${Number(s10.annualPremium || s3.AmountOfPaymentWithThisApplication).toLocaleString()}` : '0',
          address: s1.regFullAddr || `${s1.regAddrNum || ''} ${s1.regAddrStrNum || ''} ${s1.regAddrProvince || ''}`.trim(),
          occLevelLife: 'Class 1',
          occLevelAccident: 'Class 1',
          occLevelHealth: 'Standard',
          tpdExposure: 'Low',
          medicalReport: 'Pending Review'
        };

        setCaseData(mapped);

        // Initialize Risk Dropdowns from data
        setRiskValues({
            life: mapped.occLevelLife,
            accident: mapped.occLevelAccident,
            health: mapped.occLevelHealth
        });

        // Initialize Policy List (Simulating a list based on the single case)
        setPolicyList([{
            id: 'POL-001',
            productName: mapped.productName,
            sumAssured: mapped.sumAssured,
            premium: mapped.premium,
            status: 'Pending'
        }]);

      } catch (error) {
        console.error("Error fetching details", error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [txnTypeId]);

  const handleDecisionSubmit = (data: any) => {
    console.log("Decision from Modal:", data);
  };

  // --- Handlers for Selection ---
  const handleSelectAllClick = (event: React.ChangeEvent<HTMLInputElement>) => {
    if (event.target.checked) {
      const newSelecteds = policyList.map((n) => n.id);
      setSelectedPolicyIds(newSelecteds);
      return;
    }
    setSelectedPolicyIds([]);
  };

  const handleRowClick = (id: string) => {
    const selectedIndex = selectedPolicyIds.indexOf(id);
    let newSelected: string[] = [];

    if (selectedIndex === -1) {
      newSelected = newSelected.concat(selectedPolicyIds, id);
    } else if (selectedIndex === 0) {
      newSelected = newSelected.concat(selectedPolicyIds.slice(1));
    } else if (selectedIndex === selectedPolicyIds.length - 1) {
      newSelected = newSelected.concat(selectedPolicyIds.slice(0, -1));
    } else if (selectedIndex > 0) {
      newSelected = newSelected.concat(
        selectedPolicyIds.slice(0, selectedIndex),
        selectedPolicyIds.slice(selectedIndex + 1),
      );
    }
    setSelectedPolicyIds(newSelected);
  };

  const isSelected = (id: string) => selectedPolicyIds.indexOf(id) !== -1;

  // --- PREPARE DATA FOR MODAL ---
  // This maps the selected rows from the parent table to the detailed format needed for the modal
  const policiesForModal: PolicyProduct[] = policyList
    .filter(policy => selectedPolicyIds.includes(policy.id))
    .map((policy, index) => ({
        id: policy.id,
        sequence: (100 + index).toString(), // Mock sequence
        code: '6968', // Mock code
        name: policy.productName,
        insured: caseData?.applicantName || 'Unknown',
        inceptionDate: dayjs().add(1, 'year').format('YYYY-MM-DD'), // Mock inception
        nextPaymentDate: '',
        status: 'Underwriting Postponed', // Mock status
        // Financials
        laySumAssured: policy.sumAssured,
        targetPremium: policy.premium,
        em: '0',
        perMille: '0',
        increaseRate: '0.0',
        decision: 'Conditional Underwritten',
        finishStatus: 'Finished'
    }));

  // --- Render Helpers ---
  if (loading) return <Box sx={{ p: 5, textAlign: 'center' }}><CircularProgress /></Box>;
  if (!caseData) return <Box sx={{ p: 3 }}><Typography>No records found.</Typography><Button startIcon={<ArrowBack />} onClick={() => navigate('/underwriting')}>Back</Button></Box>;

  const SectionHeader = ({ title, icon }: { title: string, icon: React.ReactNode }) => (
    <Box sx={{ display: 'flex', alignItems: 'center', mb: 2, mt: 4, pb: 1, borderBottom: '1px solid #e0e0e0' }}>
      <Box sx={{ color: 'primary.main', mr: 1, display: 'flex' }}>{icon}</Box>
      <Typography variant="h6" fontWeight="bold" color="text.primary">{title}</Typography>
    </Box>
  );

  const InfoRow = ({ label, value }: { label: string, value: string | React.ReactNode }) => (
    <Grid item xs={12} sm={6} md={3}>
      <Typography variant="caption" color="text.secondary" display="block" sx={{ mb: 0.5, textTransform: 'uppercase', fontSize: '0.7rem', letterSpacing: '0.5px' }}>{label}</Typography>
      <Typography variant="body2" fontWeight="500">{value}</Typography>
    </Grid>
  );

  return (
    <Box sx={{ p: 3, maxWidth: 1400, margin: 'auto', backgroundColor: '#f4f6f8', minHeight: '100vh' }}>
      
      {/* Top Nav */}
      <Stack direction="row" alignItems="center" spacing={2} sx={{ mb: 3 }}>
        <IconButton onClick={() => navigate('/underwriting')} sx={{ bgcolor: 'white', border: '1px solid #ccc' }}><ArrowBack /></IconButton>
        <Box>
          <Typography variant="h5" fontWeight="bold" color="text.primary">Underwriting Details</Typography>
          <Typography variant="body2" color="text.secondary">Reviewing Application: {txnTypeId}</Typography>
        </Box>
      </Stack>

      {/* 1. Header Info */}
      <Paper elevation={0} sx={{ p: 3, borderRadius: 2, border: '1px solid #e0e0e0' }}>
        <Grid container spacing={3}>
          <InfoRow label="Underwriting Code" value={caseData.uwCode} />
          <InfoRow label="Creation Date" value={caseData.creationDate} />
          <InfoRow label="Applicant Name" value={caseData.applicantName} />
          <InfoRow label="Service Type" value={<Chip label={caseData.serviceType} color="primary" size="small" variant="outlined"/>} />
        </Grid>
      </Paper>

      {/* 2. Basic Info */}
      <SectionHeader title="Policy / Application Basic Info" icon={<Assignment />} />
      <Paper elevation={1} sx={{ p: 3, borderRadius: 2 }}>
        <Grid container spacing={3}>
          <InfoRow label="Application No." value={caseData.appNumber} />
          <InfoRow label="Policy No." value={caseData.policyNumber} />
          <InfoRow label="Agent Code" value={caseData.agentCode} />
          <InfoRow label="Branch" value={caseData.branch} />
          <InfoRow label="Product Name" value={caseData.productName} />
          <InfoRow label="Email" value={caseData.email} />
          <InfoRow label="Mobile" value={caseData.mobile} />
        </Grid>
      </Paper>

      {/* 3. Proposer Info */}
      <SectionHeader title="Proposer Information" icon={<Person />} />
      <Paper elevation={1} sx={{ p: 3, borderRadius: 2 }}>
        <Grid container spacing={3}>
          <InfoRow label="Full Name" value={caseData.applicantName} />
          <InfoRow label="DOB" value={caseData.dob} />
          <InfoRow label="Gender" value={caseData.gender} />
          <InfoRow label="Occupation" value={caseData.occupation} />
          <InfoRow label="Income" value={caseData.income} />
          <InfoRow label="Sum Assured" value={`INR ${caseData.sumAssured}`} />
          <InfoRow label="Premium" value={`INR ${caseData.premium}`} />
          <Grid item xs={12}>
            <Divider sx={{ my: 1 }} />
            <Typography variant="caption" color="text.secondary" sx={{ textTransform: 'uppercase', fontSize: '0.7rem' }}>Permanent Address</Typography>
            <Typography variant="body2">{caseData.address}</Typography>
          </Grid>
        </Grid>
      </Paper>

      {/* 4. Risk Assessment */}
      <SectionHeader title="Risk Assessment" icon={<LocalHospital />} />
      <Paper elevation={1} sx={{ p: 3, borderRadius: 2 }}>
        <Grid container spacing={3}>
          <Grid item xs={12} sm={6} md={3}>
            <FormControl fullWidth size="small">
                <InputLabel>Life Occ. Level</InputLabel>
                <Select 
                    value={riskValues.life} 
                    label="Life Occ. Level"
                    onChange={(e) => setRiskValues({...riskValues, life: e.target.value})}
                >
                    <MenuItem value="Class 1">Class 1</MenuItem>
                    <MenuItem value="Class 2">Class 2</MenuItem>
                    <MenuItem value="Class 3">Class 3</MenuItem>
                    <MenuItem value="Class 4">Class 4</MenuItem>
                    <MenuItem value="Standard">Standard</MenuItem>
                </Select>
            </FormControl>
          </Grid>

          <Grid item xs={12} sm={6} md={3}>
             <FormControl fullWidth size="small">
                <InputLabel>Accident Occ. Level</InputLabel>
                <Select 
                    value={riskValues.accident} 
                    label="Accident Occ. Level"
                    onChange={(e) => setRiskValues({...riskValues, accident: e.target.value})}
                >
                    <MenuItem value="Class 1">Class 1</MenuItem>
                    <MenuItem value="Class 2">Class 2</MenuItem>
                    <MenuItem value="Class 3">Class 3</MenuItem>
                    <MenuItem value="Standard">Standard</MenuItem>
                    <MenuItem value="Declined">Declined</MenuItem>
                </Select>
            </FormControl>
          </Grid>

          <Grid item xs={12} sm={6} md={3}>
            <FormControl fullWidth size="small">
                <InputLabel>Health Occ. Level</InputLabel>
                <Select 
                    value={riskValues.health} 
                    label="Health Occ. Level"
                    onChange={(e) => setRiskValues({...riskValues, health: e.target.value})}
                >
                    <MenuItem value="Standard">Standard</MenuItem>
                    <MenuItem value="Sub-Standard A">Sub-Standard A</MenuItem>
                    <MenuItem value="Sub-Standard B">Sub-Standard B</MenuItem>
                    <MenuItem value="Declined">Declined</MenuItem>
                </Select>
            </FormControl>
          </Grid>

          <InfoRow label="Medical Report" value={caseData.medicalReport} />
        </Grid>
      </Paper>

      {/* 5. Policy Table */}
      <SectionHeader title="Policy Details" icon={<Assessment />} />
      <TableContainer component={Paper} elevation={1} sx={{ borderRadius: 2 }}>
        <Table size="small">
          <TableHead sx={{ bgcolor: '#f5f5f5' }}>
            <TableRow>
              {/* Select All Checkbox */}
              <TableCell padding="checkbox">
                <Checkbox
                  color="primary"
                  indeterminate={selectedPolicyIds.length > 0 && selectedPolicyIds.length < policyList.length}
                  checked={policyList.length > 0 && selectedPolicyIds.length === policyList.length}
                  onChange={handleSelectAllClick}
                  inputProps={{ 'aria-label': 'select all policies' }}
                />
              </TableCell>
              <TableCell><strong>Product Name</strong></TableCell>
              <TableCell><strong>Sum Assured</strong></TableCell>
              <TableCell><strong>Annual Premium</strong></TableCell>
              <TableCell><strong>UW Decision</strong></TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {policyList.map((row) => {
                const isItemSelected = isSelected(row.id);
                return (
                    <TableRow 
                        key={row.id} 
                        hover
                        role="checkbox"
                        aria-checked={isItemSelected}
                        selected={isItemSelected}
                    >
                        {/* Row Checkbox */}
                        <TableCell padding="checkbox">
                            <Checkbox
                                color="primary"
                                checked={isItemSelected}
                                onClick={() => handleRowClick(row.id)}
                            />
                        </TableCell>
                        <TableCell>{row.productName}</TableCell>
                        <TableCell>{row.sumAssured}</TableCell>
                        <TableCell>{row.premium}</TableCell>
                        <TableCell><Typography color="orange" fontWeight="bold">{row.status}</Typography></TableCell>
                    </TableRow>
                );
            })}
            {policyList.length === 0 && (
                <TableRow>
                    <TableCell colSpan={5} align="center">No policies found</TableCell>
                </TableRow>
            )}
          </TableBody>
        </Table>
      </TableContainer>

      {/* 6. Quick Action / Open Modal */}
      <SectionHeader title="Underwriting Action" icon={<Gavel />} />
      <Paper elevation={3} sx={{ p: 4, mb: 5, borderRadius: 2, borderLeft: '6px solid #1976d2' }}>
        <Grid container spacing={3}>
          <Grid item xs={12} md={8}>
            <TextField 
              fullWidth 
              label="Quick Comments / Notes" 
              multiline 
              rows={2} 
              placeholder="Enter internal remarks..."
              value={comments}
              onChange={(e) => setComments(e.target.value)}
            />
          </Grid>
          <Grid item xs={12} display="flex" justifyContent="flex-end" gap={2} mt={1}>
            <Button 
                variant='outlined' 
                size="large" 
                onClick={() => setOpenModal(true)}
                // DISABLE LOGIC: Button is disabled if no rows are selected
                disabled={selectedPolicyIds.length === 0}
            >
              Underwriting Decision
            </Button>
            <Button variant='contained' size="large" onClick={() => {}}>
              Underwritten
            </Button>
          </Grid>
        </Grid>
      </Paper>
      
      {/* INTEGRATED MODAL: Passing the mapped selected policies */}
      <DecisionModal 
        open={openModal} 
        onClose={() => setOpenModal(false)} 
        selectedPolicies={policiesForModal} 
        onSubmit={handleDecisionSubmit}
      />

    </Box>
  );
};

export default UnderwritingDetails;
