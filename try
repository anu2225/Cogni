import {
  Box,
  Divider,
  Link,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  TextField,
  Typography,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  SelectChangeEvent,
} from "@mui/material";

import React, { useEffect, useState } from "react";

import { useTranslation } from "react-i18next";

interface ChildComponentProps {
  fields: {
    basicPlan: string;

    basicSumInsured: string;

    basicPlanPremium: string;

    typeOfDivident: string;

    insuranceTerm: string;

    ppt: string;

    Product: string;

    Policy_Inception_Date: string;

    Smoker: string;

    Pre_Existing_Disease: string;

    Extra_mortality: string;

    Policy_Term: string;

    Mandatory_Premium_Period: string;

    PAV: string;

    per_mille_rating_death: string;

    per_mille_rating_TPD: string;

    per_mille_rating_SCI: string;

    Death_Benefit: string;

    Total_and_Permanent_Disability_TPD: string;

    Accidental_Death_and_Dismemberment_ADD: string;

    Staged_Critical_Illness_SCI: string;

    _2e_Hospital_Cash_Benefit_HCB: string;

    Partial_Withdrawl: string;

    Partial_Withdrawl_Amount: string;
  };

  setFields: React.Dispatch<
    React.SetStateAction<{
      basicPlan: string;

      basicSumInsured: string;

      basicPlanPremium: string;

      typeOfDivident: string;

      insuranceTerm: string;

      ppt: string;

      Product: string;

      Policy_Inception_Date: string;

      Smoker: string;

      Pre_Existing_Disease: string;

      Extra_mortality: string;

      Policy_Term: string;

      Mandatory_Premium_Period: string;

      PAV: string;

      per_mille_rating_death: string;

      per_mille_rating_TPD: string;

      per_mille_rating_SCI: string;

      Death_Benefit: string;

      Total_and_Permanent_Disability_TPD: string;

      Accidental_Death_and_Dismemberment_ADD: string;

      Staged_Critical_Illness_SCI: string;

      _2e_Hospital_Cash_Benefit_HCB: string;

      Partial_Withdrawl: string;

      Partial_Withdrawl_Amount: string;
    }>
  >;

  savedQuotation: any;

  savedTransaction: any;
}

const MAIN_PLANS = [
  "Term Insurance",
  "Whole Life Insurance", 
  "Universal Life Insurance",
  "Endowment Plan"
];

const RIDERS = [
  "ADD",
  "CI",
  "WOP",
  "HCB",
  "DB"
];

const YES_NO = ["Yes", "No"];

const PRODUCT_OPTIONS = ["a", "b"];

const EXTRA_MORTALITY_OPTIONS = ["5%", "10%", "15%", "20%", "25%", "30%", "35%", "40%", "45%", "50%", "55%", "60%", "65%", "70%", "75%", "80%", "85%", "90%", "95%", "100%"];

const camelToNormal = (text: string) => {
  return text
    .replace(/([A-Z])/g, " $1")
    .replace(/^./, (str) => str.toUpperCase());
};

const PlanAndCoverage: React.FC<ChildComponentProps> = ({
  fields,

  setFields,

  savedQuotation,

  savedTransaction,
}) => {
  let jsonData;

  let headers: any[] = [];

  let OptRiderData;

  let OptHeaders: any[] = [];

  const [selectedRiders, setSelectedRiders] = useState<string[]>([]);

  const handleFieldChange = (val: string, fieldName: string) => {
    setFields({ ...fields, [fieldName]: val });
  };

  const handlePlanChange = (event: SelectChangeEvent<string>) => {
    const selectedPlan = event.target.value;
    handleFieldChange(selectedPlan, "basicPlan");
    
    // Set default values based on plan type
    const defaultSumInsured = getDefaultSumInsured(selectedPlan);
    const defaultPremium = calculatePremium(defaultSumInsured, selectedPlan);
    
    handleFieldChange(defaultSumInsured.toString(), "basicSumInsured");
    handleFieldChange(defaultPremium.toString(), "basicPlanPremium");
  };

  const getDefaultSumInsured = (planType: string): number => {
    switch (planType) {
      case "Term Insurance": return 1000000;
      case "Whole Life Insurance": return 500000;
      case "Universal Life Insurance": return 750000;
      case "Endowment Plan": return 300000;
      default: return 500000;
    }
  };

  const calculatePremium = (sumInsured: number, planType: string): number => {
    const baseRate = {
      "Term Insurance": 0.002,
      "Whole Life Insurance": 0.015,
      "Universal Life Insurance": 0.012,
      "Endowment Plan": 0.025
    };
    return Math.round(sumInsured * (baseRate[planType as keyof typeof baseRate] || 0.01));
  };

  const handleRiderChange = (event: SelectChangeEvent<string[]>) => {
    const value = event.target.value;
    setSelectedRiders(typeof value === 'string' ? value.split(',') : value);
  };

  const { t } = useTranslation();

  useEffect(() => {
    if (savedTransaction && savedTransaction.length > 0) {
      const baseSA = savedTransaction[0]?.txn_input_json?.Base_SA;

      const plan = savedTransaction[0]?.txn_input_json?.Plan;

      const term = savedTransaction[0]?.txn_input_json["SSPP.Policy_Term"];

      const ppt = savedTransaction[0]?.txn_input_json?.PPT;

      setFields((prevFields) => ({
        ...prevFields,

        basicPlanPremium:
          savedTransaction[0]?.txn_output_json?.outputs?.PremiumSummary[1]
            ?.basePlan,

        basicSumInsured: baseSA || '200000',

        basicPlan: plan,

        insuranceTerm: term,

        ppt: ppt,

        typeOfDivident: "Non - Participatory",

        Product: '',

        Policy_Inception_Date: new Date().toISOString().split('T')[0],

        Smoker: 'No',

        Pre_Existing_Disease: 'Yes',

        Extra_mortality: '75%',

        Policy_Term: '45',

        Mandatory_Premium_Period: 'ErrName',

        PAV: '0',

        per_mille_rating_death: '1',

        per_mille_rating_TPD: '1',

        per_mille_rating_SCI: '1',

        Death_Benefit: 'Yes',

        Total_and_Permanent_Disability_TPD: 'Yes',

        Accidental_Death_and_Dismemberment_ADD: 'Yes',

        Staged_Critical_Illness_SCI: 'Yes',

        _2e_Hospital_Cash_Benefit_HCB: 'Y',

        Partial_Withdrawl: 'Yes',

        Partial_Withdrawl_Amount: '5000',
      }));
    } else {
      // Set defaults when no savedTransaction
      setFields((prevFields) => ({
        ...prevFields,

        basicSumInsured: '200000',

        Product: '',

        Policy_Inception_Date: new Date().toISOString().split('T')[0],

        Smoker: 'No',

        Pre_Existing_Disease: 'Yes',

        Extra_mortality: '75%',

        Policy_Term: '45',

        Mandatory_Premium_Period: 'ErrName',

        PAV: '0',

        per_mille_rating_death: '1',

        per_mille_rating_TPD: '1',

        per_mille_rating_SCI: '1',

        Death_Benefit: 'Yes',

        Total_and_Permanent_Disability_TPD: 'Yes',

        Accidental_Death_and_Dismemberment_ADD: 'Yes',

        Staged_Critical_Illness_SCI: 'Yes',

        _2e_Hospital_Cash_Benefit_HCB: 'Y',

        Partial_Withdrawl: 'Yes',

        Partial_Withdrawl_Amount: '5000',
      }));
    }
