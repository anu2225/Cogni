import React, { useState, useEffect } from 'react';
import {
  Box,
  Paper,
  Typography,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Button,
  Stack,
  CircularProgress,
  Alert,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  IconButton,
  TextField
} from '@mui/material';
import { ArrowBack } from '@mui/icons-material';
import { useNavigate, useParams } from 'react-router-dom';
import axios from '../../api/axiosInterceptor';

interface ProofingData {
  id: string;
  name: string;
  status: string;
  workType: string;
  [key: string]: any;
}

const ProofingPolicyList: React.FC = () => {
  const navigate = useNavigate();
  const { txnTypeId } = useParams();

  const [workType, setWorkType] = useState<string>('GenerateQuote');
  const [loading, setLoading] = useState<boolean>(false);
  const [error, setError] = useState<string>('');
  const [successMessage, setSuccessMessage] = useState<string>('');
  const [proofingData, setProofingData] = useState<ProofingData[]>([]);
  const [hasApplied, setHasApplied] = useState<boolean>(false);

  // FLOW STATUS
  const uwStatus = 'UW In Progress'; // UW Ready | UW In Progress | UW Complete
  const isReadOnly = uwStatus === 'UW Complete';

  // Map display names to work codes
  const workTypeMap: { [key: string]: string } = {
    GenerateQuote: 'W021225-1',
    QuoteUWR: 'W021225-3',
  };

  const handleApplyChanges = async (selectedWorkCode?: string) => {
    setLoading(true);
    setError('');
    setSuccessMessage('');

    try {
      const codeToUse = selectedWorkCode || workTypeMap[workType];

      await axios.post(`http://localhost:8001/eapp/setRuleDef`, {
        workCode: codeToUse,
        quoteId: txnTypeId,
      });

      const getResponse = await axios.get(
        `http://localhost:8001/eapp/getByWorkType?workCode=${codeToUse}`
      );

      setProofingData(getResponse.data || []);
      setSuccessMessage('Successfully applied changes and loaded data');
      setHasApplied(true);
    } catch (err: any) {
      const errorMessage =
        err.response?.data?.message ||
        err.response?.data?.error ||
        err.message ||
        'Failed to apply changes';
      setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  const handleOpenDetails = (id: string) => {
    navigate(`/proofing/${id}`);
  };

  return (
    <Box
      sx={{
        p: 3,
        maxWidth: 1400,
        margin: 'auto',
        backgroundColor: '#f4f6f8',
        minHeight: '100vh',
      }}
    >
      {/* HEADER */}
      <Stack direction="row" alignItems="center" spacing={2} sx={{ mb: 3 }}>
        <IconButton
          onClick={() => navigate(-1)}
          sx={{ bgcolor: 'white', border: '1px solid #ccc' }}
        >
          <ArrowBack />
        </IconButton>
        <Box>
          <Typography variant="h5" fontWeight="bold">
            Proofing Management
          </Typography>
          <Typography variant="body2" color="text.secondary">
            {txnTypeId
              ? `Viewing Proofing for: ${txnTypeId}`
              : 'Select work type to view proofing data'}
          </Typography>
        </Box>
      </Stack>

      {/* FILTER SECTION */}
      <Paper elevation={2} sx={{ p: 3, borderRadius: 2, mb: 3 }}>
        <Typography variant="h6" fontWeight="bold" sx={{ mb: 2 }}>
          Filter Proofing Data
        </Typography>

        <Stack direction="row" spacing={2} alignItems="flex-end">
          <FormControl sx={{ minWidth: 250 }}>
            <InputLabel id="work-type-label">Work Type</InputLabel>
            <Select
              labelId="work-type-label"
              value={workType}
              label="Work Type"
              disabled={loading}
            >
              <MenuItem value="GenerateQuote">Generate Quote</MenuItem>
              <MenuItem value="QuoteUWR">Quote UWR</MenuItem>
            </Select>

            <Button
              variant="contained"
              sx={{ mt: 2 }}
              onClick={() => handleApplyChanges()}
              disabled={loading}
            >
              Approve
            </Button>
          </FormControl>

          {loading && <CircularProgress size={24} />}
        </Stack>

        {error && <Alert severity="error" sx={{ mt: 2 }}>{error}</Alert>}
        {successMessage && (
          <Alert severity="success" sx={{ mt: 2 }}>
            {successMessage}
          </Alert>
        )}
      </Paper>

      {/* APPLICATION BASIC INFO */}
      <Paper elevation={2} sx={{ p: 3, borderRadius: 2, mb: 3 }}>
        <Typography variant="h6" fontWeight="bold" gutterBottom>
          Application Basic Info
        </Typography>

        <Box display="grid" gridTemplateColumns="repeat(3, 1fr)" gap={2}>
          <TextField label="Client Name" disabled={isReadOnly} />
          <TextField label="Client No." disabled={isReadOnly} />
          <TextField label="Quotation Number" disabled={isReadOnly} />
          <TextField
            label="Quotation Date"
            type="date"
            InputLabelProps={{ shrink: true }}
            disabled={isReadOnly}
          />
          <TextField label="Application Number" disabled={isReadOnly} />
          <TextField label="Product Name" disabled={isReadOnly} />
          <TextField label="Sum Assured" disabled={isReadOnly} />
          <TextField label="Annual Premium" disabled={isReadOnly} />
          <TextField
            label="Issue Date"
            type="date"
            InputLabelProps={{ shrink: true }}
            disabled={isReadOnly}
          />
        </Box>
      </Paper>

      {/* COVERAGE – BASE */}
      <Paper elevation={2} sx={{ p: 3, borderRadius: 2, mb: 3 }}>
        <Typography variant="h6" fontWeight="bold">
          Coverage Details – Rider Type (Base)
        </Typography>

        <Box display="grid" gridTemplateColumns="repeat(3, 1fr)" gap={2}>
          <TextField label="Coverage Amount" disabled={isReadOnly} />
          <TextField label="Start Date" type="date" InputLabelProps={{ shrink: true }} disabled={isReadOnly} />
          <TextField label="End Date" type="date" InputLabelProps={{ shrink: true }} disabled={isReadOnly} />
          <TextField label="Issue Age" disabled={isReadOnly} />
          <TextField label="Tobacco" disabled={isReadOnly} />
          <TextField label="UW Class" disabled={isReadOnly} />
          <TextField label="Table Rating" disabled={isReadOnly} />
          <TextField label="Perm Flat Extra" disabled={isReadOnly} />
          <TextField label="Temp Flat Extra" disabled={isReadOnly} />
          <TextField label="Temp Flat Extra Duration" disabled={isReadOnly} />
        </Box>
      </Paper>

      {/* COVERAGE – ADB */}
      <Paper elevation={2} sx={{ p: 3, borderRadius: 2, mb: 3 }}>
        <Typography variant="h6" fontWeight="bold">
          Rider Type (ADB)
        </Typography>

        <Box display="grid" gridTemplateColumns="repeat(3, 1fr)" gap={2}>
          <TextField label="Coverage Amount" disabled={isReadOnly} />
          <TextField label="Start Date" type="date" InputLabelProps={{ shrink: true }} disabled={isReadOnly} />
          <TextField label="End Date" type="date" InputLabelProps={{ shrink: true }} disabled={isReadOnly} />
          <TextField label="Issue Age" disabled={isReadOnly} />
          <TextField label="UW Class" disabled={isReadOnly} />
          <TextField label="Table Rating" disabled={isReadOnly} />
        </Box>
      </Paper>

      {/* COVERAGE – WOP */}
      <Paper elevation={2} sx={{ p: 3, borderRadius: 2 }}>
        <Typography variant="h6" fontWeight="bold">
          Rider Type (Waiver of Premium)
        </Typography>

        <Box display="grid" gridTemplateColumns="repeat(3, 1fr)" gap={2}>
          <TextField label="Coverage Amount" disabled={isReadOnly} />
          <TextField label="Start Date" type="date" InputLabelProps={{ shrink: true }} disabled={isReadOnly} />
          <TextField label="End Date" type="date" InputLabelProps={{ shrink: true }} disabled={isReadOnly} />
          <TextField label="Issue Age" disabled={isReadOnly} />
          <TextField label="UW Class" disabled={isReadOnly} />
          <TextField label="Table Rating" disabled={isReadOnly} />
        </Box>
      </Paper>

      {/* SAVE & NEXT BUTTONS */}
      <Paper elevation={0} sx={{ p: 3, mt: 2, textAlign: 'right' }}>
        <Stack direction="row" spacing={2} justifyContent="flex-end">
          <Button
            variant="outlined"
            color="primary"
            onClick={() => {
              console.log('Save clicked');
            }}
          >
            Save
          </Button>

          <Button
            variant="contained"
            color="primary"
            onClick={() => {
              navigate('/proofing/next');
            }}
          >
            Next
          </Button>
        </Stack>
      </Paper>
    </Box>
  );
};

export default ProofingPolicyList;


