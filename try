import dayjs from "dayjs";
import {
  Box,
  Divider,
  Link,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  TextField,
  Typography,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  SelectChangeEvent,
  Button,
  CircularProgress,
} from "@mui/material";

import React, { useEffect, useState } from "react";

import { useTranslation } from "react-i18next";
import { getAxiosInstance } from "../api/apiClient";

interface ChildComponentProps {
  fields: {
    basicPlan: string;
    basicSumInsured: string;
    basicPlanPremium: string;
    typeOfDivident: string;
    insuranceTerm: string;
    ppt: string;
    Product: string;
    Policy_Inception_Date: string;
    Smoker: string;
    Pre_Existing_Disease: string;
    Extra_mortality: string;
    Policy_Term: string;
    Mandatory_Premium_Period: string;
    PAV: string;
    per_mille_rating_death: string;
    per_mille_rating_TPD: string;
    per_mille_rating_SCI: string;
    Death_Benefit: string;
    Total_and_Permanent_Disability_TPD: string;
    Accidental_Death_and_Dismemberment_ADD: string;
    Staged_Critical_Illness_SCI: string;
    _2e_Hospital_Cash_Benefit_HCB: string;
    Partial_Withdrawl: string;
    Partial_Withdrawl_Amount: string;
    // from LifeAssuredDetail
    insuredDateOfBirth?: any;
    insuredGender?: string;
    occupationCode?: string;
  };

  setFields: React.Dispatch<
    React.SetStateAction<{
      basicPlan: string;
      basicSumInsured: string;
      basicPlanPremium: string;
      typeOfDivident: string;
      insuranceTerm: string;
      ppt: string;
      Product: string;
      Policy_Inception_Date: string;
      Smoker: string;
      Pre_Existing_Disease: string;
      Extra_mortality: string;
      Policy_Term: string;
      Mandatory_Premium_Period: string;
      PAV: string;
      per_mille_rating_death: string;
      per_mille_rating_TPD: string;
      per_mille_rating_SCI: string;
      Death_Benefit: string;
      Total_and_Permanent_Disability_TPD: string;
      Accidental_Death_and_Dismemberment_ADD: string;
      Staged_Critical_Illness_SCI: string;
      _2e_Hospital_Cash_Benefit_HCB: string;
      Partial_Withdrawl: string;
      Partial_Withdrawl_Amount: string;
    }>
  >;

  savedQuotation: any;
  savedTransaction: any;
}

const MAIN_PLANS = [
  "Term Insurance",
  "Whole Life Insurance",
  "Universal Life Insurance",
  "Endowment Plan",
];

const RIDERS = ["ADD", "CI", "WOP", "HCB", "DB"];

const YES_NO = ["Yes", "No"];

const PRODUCT_OPTIONS = ["a", "b"];

const EXTRA_MORTALITY_OPTIONS = [
  "5%",
  "10%",
  "15%",
  "20%",
  "25%",
  "30%",
  "35%",
  "40%",
  "45%",
  "50%",
  "55%",
  "60%",
  "65%",
  "70%",
  "75%",
  "80%",
  "85%",
  "90%",
  "95%",
  "100%",
];

const camelToNormal = (text: string) => {
  return text
    .replace(/([A-Z])/g, " $1")
    .replace(/^./, (str) => str.toUpperCase());
};

const API_CALCULATE_PATH =
  "/cognizant/api/v3/folders/Sanjana_Test/services/Universal-Life-product-TestPrd/execute";

const PlanAndCoverage: React.FC<ChildComponentProps> = ({
  fields,
  setFields,
  savedQuotation,
  savedTransaction,
}) => {
  let jsonData: any;
  let headers: any[] = [];
  let OptRiderData: any;
  let OptHeaders: any[] = [];

  const [selectedRiders, setSelectedRiders] = useState<string[]>([]);

  const [loading, setLoading] = useState(false);
  const [calcResult, setCalcResult] = useState<any>(null);
  const [errorMsg, setErrorMsg] = useState("");

  const handleFieldChange = (val: string, fieldName: string) => {
    setFields({ ...fields, [fieldName]: val });
  };

  const handlePlanChange = (event: SelectChangeEvent<string>) => {
    const selectedPlan = event.target.value;
    handleFieldChange(selectedPlan, "basicPlan");

    // Set default values based on plan type
    const defaultSumInsured = getDefaultSumInsured(selectedPlan);
    const defaultPremium = calculatePremium(defaultSumInsured, selectedPlan);

    handleFieldChange(defaultSumInsured.toString(), "basicSumInsured");
    handleFieldChange(defaultPremium.toString(), "basicPlanPremium");
  };

  const getDefaultSumInsured = (planType: string): number => {
    switch (planType) {
      case "Term Insurance":
        return 1000000;
      case "Whole Life Insurance":
        return 500000;
      case "Universal Life Insurance":
        return 750000;
      case "Endowment Plan":
        return 300000;
      default:
        return 500000;
    }
  };

  const calculatePremium = (sumInsured: number, planType: string): number => {
    const baseRate = {
      "Term Insurance": 0.002,
      "Whole Life Insurance": 0.015,
      "Universal Life Insurance": 0.012,
      "Endowment Plan": 0.025,
    };
    return Math.round(
      sumInsured * (baseRate[planType as keyof typeof baseRate] || 0.01)
    );
  };

  const handleRiderChange = (event: SelectChangeEvent<string[]>) => {
    const value = event.target.value;
    setSelectedRiders(typeof value === "string" ? value.split(",") : value);
  };

  const { t } = useTranslation();

  useEffect(() => {
    if (savedTransaction && savedTransaction.length > 0) {
      const baseSA = savedTransaction[0]?.txn_input_json?.Base_SA;
      const plan = savedTransaction[0]?.txn_input_json?.Plan;
      const term = savedTransaction[0]?.txn_input_json["SSPP.Policy_Term"];
      const ppt = savedTransaction[0]?.txn_input_json?.PPT;

      setFields((prevFields) => ({
        ...prevFields,
        basicPlanPremium:
          savedTransaction[0]?.txn_output_json?.outputs?.PremiumSummary[1]
            ?.basePlan,
        basicSumInsured: baseSA || "200000",
        basicPlan: plan,
        insuranceTerm: term,
        ppt: ppt,
        typeOfDivident: "Non - Participatory",
        Product: "",
        Policy_Inception_Date: new Date().toISOString().split("T")[0],
        Smoker: "No",
        Pre_Existing_Disease: "Yes",
        Extra_mortality: "75%",
        Policy_Term: "45",
        Mandatory_Premium_Period: "ErrName",
        PAV: "0",
        per_mille_rating_death: "1",
        per_mille_rating_TPD: "1",
        per_mille_rating_SCI: "1",
        Death_Benefit: "Yes",
        Total_and_Permanent_Disability_TPD: "Yes",
        Accidental_Death_and_Dismemberment_ADD: "Yes",
        Staged_Critical_Illness_SCI: "Yes",
        _2e_Hospital_Cash_Benefit_HCB: "Y",
        Partial_Withdrawl: "Yes",
        Partial_Withdrawl_Amount: "5000",
      }));
    } else {
      // Set defaults when no savedTransaction
      setFields((prevFields) => ({
        ...prevFields,
        basicSumInsured: "200000",
        Product: "",
        Policy_Inception_Date: new Date().toISOString().split("T")[0],
        Smoker: "No",
        Pre_Existing_Disease: "Yes",
        Extra_mortality: "75%",
        Policy_Term: "45",
        Mandatory_Premium_Period: "ErrName",
        PAV: "0",
        per_mille_rating_death: "1",
        per_mille_rating_TPD: "1",
        per_mille_rating_SCI: "1",
        Death_Benefit: "Yes",
        Total_and_Permanent_Disability_TPD: "Yes",
        Accidental_Death_and_Dismemberment_ADD: "Yes",
        Staged_Critical_Illness_SCI: "Yes",
        _2e_Hospital_Cash_Benefit_HCB: "Y",
        Partial_Withdrawl: "Yes",
        Partial_Withdrawl_Amount: "5000",
      }));
    }
  }, [savedTransaction]);

  if (
    savedTransaction &&
    typeof savedTransaction === "object" &&
    Object.keys(savedTransaction).length !== 0
  ) {
    jsonData = savedTransaction[0]?.txn_output_json?.outputs?.RiderDetails;
    if (jsonData?.length) {
      headers = Object.keys(jsonData[0]);
    }
    OptRiderData =
      savedTransaction[0]?.txn_output_json?.outputs?.OptionalBenefitDetails;
    if (OptRiderData?.length) {
      OptHeaders = Object.keys(OptRiderData[0]);
    }
  }

  // ---------- New helpers and API call function start ----------
  const yesNoToYN = (val?: string | null) => {
    if (!val) return "N";
    const v = val.toString().toLowerCase();
    if (v === "y" || v === "yes" || v === "true") return "Y";
    return "N";
  };

  const getAxios = () => {
    return getAxiosInstance();
  };

  const handleGetPremium = async () => {
    setLoading(true);
    setCalcResult(null);
    setErrorMsg("");

    try {
      // Build inputs mapping exactly as API expects
      const inputs: any = {
        _1a_DOB: fields.insuredDateOfBirth
          ? typeof fields.insuredDateOfBirth === "string"
            ? fields.insuredDateOfBirth
            : dayjs(fields.insuredDateOfBirth).format("YYYY-MM-DD")
          : "",

        _1b_Product: fields.Product || "",

        _1c_Gender: fields.insuredGender || "",

        _1d_Face_Amount: Number(fields.basicSumInsured || 0),

        _1e_Occupation: Number(fields.occupationCode || 0),

        _1h_Policy_Inception_Date: fields.Policy_Inception_Date
          ? fields.Policy_Inception_Date
          : dayjs().format("YYYY-MM-DD"),

        _1i_Smoker: yesNoToYN(fields.Smoker),

        _1j_Pre_Existing_Disease: yesNoToYN(fields.Pre_Existing_Disease),

        // convert "75%" -> 0.75
        _1k_Extra_mortality: (() => {
          const v = (fields.Extra_mortality || "").toString();
          if (v.endsWith("%")) {
            const n = parseFloat(v.replace("%", "")) || 0;
            return +(n / 100).toFixed(4); // e.g. 0.75
          }
          // if already decimal like "0.75"
          const num = parseFloat(v);
          if (!isNaN(num) && num > 0 && num <= 1) return num;
          if (!isNaN(num) && num > 1) return +(num / 100).toFixed(4);
          return 0;
        })(),

        _1p_Policy_Term: Number(fields.Policy_Term || 0),

        _1r_Mandatory_Premium_Period:
          fields.Mandatory_Premium_Period || "",

        _1zb_PAV: Number(fields.PAV || 0),

        _1zc_per_mille_rating_death: Number(
          fields.per_mille_rating_death || 1
        ),

        _1zd_per_mille_rating_TPD: Number(fields.per_mille_rating_TPD || 1),

        _1ze_per_mille_rating_SCI: Number(fields.per_mille_rating_SCI || 1),

        _2a_Death_Benefit: yesNoToYN(fields.Death_Benefit),

        _2b_Total_and_Permanent_Disability_TPD: yesNoToYN(
          fields.Total_and_Permanent_Disability_TPD
        ),

        _2c_Accidental_Death_and_Dismemberment_ADD: yesNoToYN(
          fields.Accidental_Death_and_Dismemberment_ADD
        ),

        _2d_Staged_Critical_Illness_SCI: yesNoToYN(
          fields.Staged_Critical_Illness_SCI
        ),

        _2e_Hospital_Cash_Benefit_HCB:
          fields._2e_Hospital_Cash_Benefit_HCB || "Y",

        _3a_Partial_Withdrawl: yesNoToYN(fields.Partial_Withdrawl),

        _3b_Partial_Withdrawl_Amount: Number(
          fields.Partial_Withdrawl_Amount || 0
        ),
      };

      const payload = {
        request_data: { inputs },
        request_meta: {
          version_id: "57e38b87-052c-4fb1-a6c5-76bd1567df2d",
          call_purpose: "Spark - API Tester",
          source_system: "SPARK",
          correlation_id: null,
          requested_output: null,
          service_category: "",
        },
      };

      const axiosInst = getAxios();
      const url = API_CALCULATE_PATH; // axiosInst has baseURL from apiClient

      const resp = await axiosInst.post(url, payload);
      setCalcResult(resp.data);
    } catch (err: any) {
      console.error(err);
      setErrorMsg(
        err?.response?.data?.message || err.message || "Request failed"
      );
    } finally {
      setLoading(false);
    }
  };
  // ---------- New helpers and API call function end ----------

  return (
    <Box sx={{ width: "100%", padding: 2 }}>
      {/* Quotation Summary */}
      <Paper elevation={3} sx={{ marginBottom: 2, padding: 2 }}>
        <Typography className="typography-main-header">{t("quotation_summaryh")}</Typography>
        <Divider />
        <Box
          sx={{
            display: "flex",
            flexDirection: { xs: "column", sm: "row" },
            marginTop: 2,
          }}
        >
          <Typography>{t("quotation_summary")}&emsp;</Typography>
          <Link
            underline="always"
            color="inherit"
            sx={{ color: "#000048" }}
            onClick={() => {
              const file = new Blob(
                [
                  Uint8Array.from(atob(savedQuotation.txn_pdf), (c) => c.charCodeAt(0)),
                ],
                {
                  type: "application/pdf",
                }
              );

              const fileURL = URL.createObjectURL(file);

              window.open(fileURL);
            }}
          >
            Download Link to Quotation
          </Link>
        </Box>
      </Paper>

      {/* Main Plan */}
      <Paper elevation={3} sx={{ marginBottom: 2, padding: 2 }}>
        <Typography className="typography-main-header">{t("main_plan")}</Typography>
        <Divider />
        <Box sx={{ marginTop: 2 }}>
          <TableContainer sx={{ width: "100%" }}>
            <Table className="table-main" sx={{ width: "100%" }}>
              <TableBody>
                <TableRow sx={{ display: "flex", flexWrap: "wrap" }}>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>{t("basicPlan")}</InputLabel>
                      <Select value={fields.basicPlan} onChange={handlePlanChange}>
                        {MAIN_PLANS.map((plan) => (
                          <MenuItem key={plan} value={plan}>
                            {plan}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>
                  {[
                    "basicSumInsured",
                    "basicPlanPremium",
                    "typeOfDivident",
                    "insuranceTerm",
                    "ppt",
                  ].map((field) => (
                    <TableCell key={field} sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                      <TextField
                        size="small"
                        label={t(field)}
                        variant="standard"
                        InputProps={{ readOnly: true }}
                        value={fields[field as keyof typeof fields]}
                        onChange={(e) => handleFieldChange(e.target.value, field)}
                      />
                    </TableCell>
                  ))}
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>Product</InputLabel>
                      <Select value={fields.Product} onChange={(e) => handleFieldChange(e.target.value, "Product")}>
                        {PRODUCT_OPTIONS.map((option) => (
                          <MenuItem key={option} value={option}>
                            {option}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <TextField
                      size="small"
                      label="Policy Inception Date"
                      variant="standard"
                      type="date"
                      value={fields.Policy_Inception_Date}
                      onChange={(e) => handleFieldChange(e.target.value, "Policy_Inception_Date")}
                    />
                  </TableCell>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>Smoker</InputLabel>
                      <Select value={fields.Smoker} onChange={(e) => handleFieldChange(e.target.value, "Smoker")}>
                        {YES_NO.map((option) => (
                          <MenuItem key={option} value={option}>
                            {option}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>Pre Existing Disease</InputLabel>
                      <Select value={fields.Pre_Existing_Disease} onChange={(e) => handleFieldChange(e.target.value, "Pre_Existing_Disease")}>
                        {YES_NO.map((option) => (
                          <MenuItem key={option} value={option}>
                            {option}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <FormControl variant="standard" size="small" fullWidth>
                      <InputLabel>Extra Mortality</InputLabel>
                      <Select value={fields.Extra_mortality} onChange={(e) => handleFieldChange(e.target.value, "Extra_mortality")}>
                        {EXTRA_MORTALITY_OPTIONS.map((option) => (
                          <MenuItem key={option} value={option}>
                            {option}
                          </MenuItem>
                        ))}
                      </Select>
                    </FormControl>
                  </TableCell>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <TextField
                      size="small"
                      label="Policy Term"
                      variant="standard"
                      value={fields.Policy_Term}
                      onChange={(e) => handleFieldChange(e.target.value, "Policy_Term")}
                    />
                  </TableCell>
                  <TableCell sx={{ flex: "1 1 30%", minWidth: "120px" }}>
                    <TextField
                      size="small"
                      label="Mandatory Premium Period"
                      variant="standard"
                      value={fields.Mandatory_Premium_Period}
                      onChange={(e) => handleFieldChange(e.target.value, "Mandatory_Premium_Period")}
                    />
                  </TableCell>
                </TableRow>
              </TableBody>
            </Table>
          </TableContainer>
        </Box>

        {/* Insert Get Premium button and result display below Main Plan section */}
        <Box sx={{ mt: 2, display: "flex", alignItems: "center", gap: 2 }}>
          <Button variant="contained" onClick={handleGetPremium} disabled={loading}>
            {loading ? <CircularProgress size={18} /> : "Get Premium"}
          </Button>

          {errorMsg && <Typography color="error">{errorMsg}</Typography>}
        </Box>

        {calcResult && (
          <Paper sx={{ mt: 2, p: 2 }}>
            <Typography variant="h6">Premium Response</Typography>
            <pre style={{ whiteSpace: "pre-wrap" }}>{JSON.stringify(calcResult, null, 2)}</pre>
          </Paper>
        )}

      </Paper>

      {/* Riders */}
      <Paper elevation={3} sx={{ marginBottom: 2, padding: 2 }}>
        <Typography className="typography-main-header">{t("riders")}</Typography>
        <Divider />
        <Box sx={{ marginTop: 2 }}>
          <FormControl variant="standard" size="small" sx={{ minWidth: 200, marginBottom: 2 }}>
            <InputLabel>Select Riders</InputLabel>
            <Select multiple value={selectedRiders} onChange={handleRiderChange} renderValue={(selected) => (selected as string[]).join(', ')}>
              {RIDERS.map((rider) => (
                <MenuItem key={rider} value={rider}>
                  {rider}
                </MenuItem>
              ))}
            </Select>
          </FormControl>
          {jsonData && (
            <TableContainer sx={{ width: "100%" }}>
              <Table sx={{ width: "100%" }}>
                <TableHead>
                  <TableRow>
                    {headers?.map((header) => (
                      <TableCell key={header}>{camelToNormal(header)}</TableCell>
                    ))}
                  </TableRow>
                </TableHead>
                <TableBody>
                  {jsonData?.map((row: any, rowIndex: number) => (
                    <TableRow key={rowIndex}>
                      {headers?.map((header) => (
                        <TableCell key={header}>{row[header]}</TableCell>
                      ))}
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </TableContainer>
          )}
        </Box>
      </Paper>

      {/* Optional Benefits */}
      <Paper elevation={3} sx={{ marginBottom: 2, padding: 2 }}>
        <Typography className="typography-main-header">{t("optional_benefits")}</Typography>
        <Divider />
        <Box sx={{ marginTop: 2 }}>
          <TableContainer sx={{ width: "100%" }}>
            <Table sx={{ width: "100%" }}>
              <TableHead>
                <TableRow>
                  {OptHeaders?.map((header) => (
                    <TableCell key={header}>{camelToNormal(header)}</TableCell>
                  ))}
                </TableRow>
              </TableHead>
              <TableBody>
                {OptRiderData?.map((row: any, rowIndex: number) => (
                  <TableRow key={rowIndex}>
                    {OptHeaders?.map((header) => (
                      <TableCell key={header}>{row[header]}</TableCell>
                    ))}
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        </Box>
      </Paper>
    </Box>
  );
};

export default PlanAndCoverage;
